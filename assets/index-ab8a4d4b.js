import{g as e,u as a,c as l,d as t}from"./category-deb9b879.js";import{K as r,E as i,f as o}from"./element-ca729cb6.js";import{v as n,r as d,U as s,l as u,ak as c,aq as m,y as v,B as p,E as f,C as y,D as h,M as g,J as _,z as b,u as w,O as V,L as k,n as O}from"./vendor-60cd9ffe.js";import{_ as C}from"./index-30b3d731.js";const I={class:"category-page"},T={class:"toolbar"},x={class:"toolbar-left"},A={class:"toolbar-right"},U={class:"category-name"},E={key:0,class:"icon-preview"},z=["src"],j=C(n({__name:"index",setup(n){const C=d(),j=d(!1),M=d([]),N=d(!0),R=d({visible:!1,loading:!1,title:"",type:"root",parentName:"",parentId:"",editingCategoryId:"",form:{name:"",parentId:null,icon:"",sortOrder:0,status:"active"}}),q=async()=>{j.value=!0,N.value=!0;try{const a=await e();let l=[];a&&"object"==typeof a&&a.data&&Array.isArray(a.data)?Array.isArray(a.data)?l=a.data:a.data.data&&Array.isArray(a.data.data)&&(l=a.data.data):a&&a.list&&Array.isArray(a.list)?l=a.list:Array.isArray(a)?l=a:(i.error("分类数据格式不正确"),l=[]),M.value=B(l)}catch(a){i.error("获取分类列表失败"),M.value=[{id:"cleaning",name:"保洁清洗",icon:"https://example.com/cleaning.png",sortOrder:1,status:"active",createTime:"2023-10-01 10:00:00",children:[{id:"daily_clean",name:"日常保洁",parentId:"cleaning",sortOrder:1,status:"active",createTime:"2023-10-01 10:00:00"},{id:"deep_clean",name:"深度保洁",parentId:"cleaning",sortOrder:2,status:"active",createTime:"2023-10-01 10:00:00"}]},{id:"nanny",name:"母婴护理",icon:"https://example.com/nanny.png",sortOrder:2,status:"active",createTime:"2023-10-01 10:00:00",children:[{id:"gold_matron",name:"金牌月嫂",parentId:"nanny",sortOrder:1,status:"active",createTime:"2023-10-01 10:00:00"}]}]}finally{j.value=!1,N.value=!1}},B=e=>{if(!Array.isArray(e))return[];if(0===e.length)return[];if(e.some(e=>e.children&&e.children.length>0)){return[...e].map(e=>({...e,status:e.status||"active"})).sort((e,a)=>(e.sortOrder||0)-(a.sortOrder||0))}const a=[],l=new Map;e.forEach(e=>{l.set(e.id,{...e,children:[],status:e.status||"active"})}),e.forEach(e=>{const t=l.get(e.id);if(e.parentId){const r=l.get(e.parentId);r?(r.children=r.children||[],r.children.push(t)):a.push(t)}else a.push(t)});const t=e=>{e.sort((e,a)=>(e.sortOrder||0)-(a.sortOrder||0)),e.forEach(e=>{e.children&&e.children.length>0&&t(e.children)})};return t(a),a},D=(e,a)=>{R.value.type=e,R.value.title="root"===e?"新增一级分类":"新增子分类",R.value.parentId=(null==a?void 0:a.id)||"",R.value.parentName=(null==a?void 0:a.name)||"",R.value.form={name:"",parentId:(null==a?void 0:a.id)||null,icon:"",sortOrder:0,status:"active"},R.value.visible=!0},L=async()=>{if(R.value.form.name){R.value.loading=!0;try{const e={name:R.value.form.name,parentId:R.value.form.parentId,icon:R.value.form.icon,sortOrder:R.value.form.sortOrder,status:R.value.form.status};if("edit"===R.value.type){const l=J();if(!l)return void i.error("分类ID不能为空");await a(l,e),i.success("更新成功")}else await l(e),i.success("创建成功");R.value.visible=!1,q()}catch(e){i.error("操作失败")}finally{R.value.loading=!1}}else i.warning("请输入分类名称")},J=()=>"edit"===R.value.type?R.value.editingCategoryId:"",K=new Map,$=new Map,F=()=>{R.value.form.icon},G=()=>{O(()=>{C.value&&M.value.forEach(e=>{C.value.toggleRowExpansion(e,!0)})})},H=()=>{O(()=>{C.value&&M.value.forEach(e=>{C.value.toggleRowExpansion(e,!1)})})};return s(()=>{$.forEach(e=>clearTimeout(e)),$.clear(),K.forEach(e=>clearTimeout(e)),K.clear()}),u(()=>{q()}),(e,l)=>{const n=c("el-button"),d=c("el-tag"),s=c("el-table-column"),u=c("el-input-number"),O=c("el-switch"),B=c("el-card"),J=c("el-input"),P=c("el-form-item"),Q=c("el-radio"),S=c("el-radio-group"),W=c("el-form"),X=c("el-dialog"),Y=m("loading");return v(),p("div",I,[f("div",T,[f("div",x,[y(n,{type:"primary",onClick:l[0]||(l[0]=e=>D("root"))},{default:h(()=>[...l[8]||(l[8]=[g("新增一级分类",-1)])]),_:1}),y(n,{onClick:G},{default:h(()=>[...l[9]||(l[9]=[g("展开全部",-1)])]),_:1}),y(n,{onClick:H},{default:h(()=>[...l[10]||(l[10]=[g("收起全部",-1)])]),_:1})]),f("div",A,[y(n,{onClick:q,loading:j.value},{default:h(()=>[...l[11]||(l[11]=[g("刷新",-1)])]),_:1},8,["loading"])])]),y(B,null,{default:h(()=>[_((v(),b(w(r),{ref_key:"tableRef",ref:C,data:M.value,"row-key":"id","tree-props":{children:"children",hasChildren:"hasChildren"},"default-expand-all":""},{default:h(()=>[y(s,{prop:"name",label:"分类名称","min-width":"200"},{default:h(({row:e})=>[f("div",U,[f("span",null,V(e.name),1),e.parentId?(v(),b(d,{key:1,size:"small",type:"info"},{default:h(()=>[...l[13]||(l[13]=[g("二级",-1)])]),_:1})):(v(),b(d,{key:0,size:"small",type:"primary"},{default:h(()=>[...l[12]||(l[12]=[g("一级",-1)])]),_:1}))])]),_:1}),y(s,{prop:"sortOrder",label:"排序",width:"100",align:"center"},{default:h(({row:e})=>[y(u,{modelValue:e.sortOrder,"onUpdate:modelValue":a=>e.sortOrder=a,min:0,size:"small",onChange:l=>(async e=>{if(!e.id)return;if(N.value)return;const l=K.get(e.id);l&&clearTimeout(l);const t=setTimeout(async()=>{try{await a(e.id,{sortOrder:e.sortOrder}),i.success("排序更新成功")}catch(l){i.error("排序更新失败")}finally{K.delete(e.id)}},800);K.set(e.id,t)})(e)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),y(s,{prop:"status",label:"状态",width:"100",align:"center"},{default:h(({row:e})=>[y(O,{modelValue:e.status,"onUpdate:modelValue":a=>e.status=a,"active-value":"active","inactive-value":"inactive","before-change":()=>(e=>{if(!e.id)return!1;if(N.value)return e.status="active"===e.status?"inactive":"active",!1;const l=$.get(e.id);l&&clearTimeout(l);const t=setTimeout(async()=>{try{await a(e.id,{status:e.status}),i.success("状态更新成功")}catch(l){e.status="active"===e.status?"inactive":"active",i.error("状态更新失败")}finally{$.delete(e.id)}},500);return $.set(e.id,t),!0})(e)},null,8,["modelValue","onUpdate:modelValue","before-change"])]),_:1}),y(s,{prop:"createTime",label:"创建时间",width:"180"}),y(s,{label:"操作",width:"200",fixed:"right"},{default:h(({row:e})=>[y(n,{link:"",type:"primary",size:"small",onClick:a=>D("child",e)},{default:h(()=>[...l[14]||(l[14]=[g(" 新增子分类 ",-1)])]),_:1},8,["onClick"]),y(n,{link:"",type:"success",size:"small",onClick:a=>{return l=e,R.value.type="edit",R.value.title="编辑分类",R.value.editingCategoryId=l.id,R.value.form={name:l.name,parentId:l.parentId||null,icon:l.icon||"",sortOrder:l.sortOrder||0,status:l.status||"active"},void(R.value.visible=!0);var l}},{default:h(()=>[...l[15]||(l[15]=[g(" 编辑 ",-1)])]),_:1},8,["onClick"]),y(n,{link:"",type:"danger",size:"small",onClick:a=>(async e=>{try{await o.confirm(`确定要删除分类 "${e.name}" 吗？此操作不可恢复。`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await t(e.id),i.success("删除成功"),q()}catch(a){"cancel"!==a&&i.error("删除失败")}})(e),disabled:e.children&&e.children.length>0},{default:h(()=>[...l[16]||(l[16]=[g(" 删除 ",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[Y,j.value]])]),_:1}),y(X,{modelValue:R.value.visible,"onUpdate:modelValue":l[7]||(l[7]=e=>R.value.visible=e),title:R.value.title,width:"500px","close-on-click-modal":!1},{footer:h(()=>[y(n,{onClick:l[6]||(l[6]=e=>R.value.visible=!1)},{default:h(()=>[...l[20]||(l[20]=[g("取消",-1)])]),_:1}),y(n,{type:"primary",loading:R.value.loading,onClick:L},{default:h(()=>[...l[21]||(l[21]=[g(" 保存 ",-1)])]),_:1},8,["loading"])]),default:h(()=>[y(W,{model:R.value.form,"label-width":"100px"},{default:h(()=>[y(P,{label:"分类名称",required:""},{default:h(()=>[y(J,{modelValue:R.value.form.name,"onUpdate:modelValue":l[1]||(l[1]=e=>R.value.form.name=e),placeholder:"请输入分类名称"},null,8,["modelValue"])]),_:1}),"child"===R.value.type?(v(),b(P,{key:0,label:"父级分类"},{default:h(()=>[y(J,{modelValue:R.value.parentName,"onUpdate:modelValue":l[2]||(l[2]=e=>R.value.parentName=e),disabled:""},null,8,["modelValue"])]),_:1})):k("",!0),"root"===R.value.type?(v(),b(P,{key:1,label:"图标"},{default:h(()=>[y(J,{modelValue:R.value.form.icon,"onUpdate:modelValue":l[3]||(l[3]=e=>R.value.form.icon=e),placeholder:"请输入图标URL"},{append:h(()=>[y(n,{onClick:F},{default:h(()=>[...l[17]||(l[17]=[g("预览",-1)])]),_:1})]),_:1},8,["modelValue"]),R.value.form.icon?(v(),p("div",E,[f("img",{src:R.value.form.icon,alt:"图标预览"},null,8,z)])):k("",!0)]),_:1})):k("",!0),y(P,{label:"排序"},{default:h(()=>[y(u,{modelValue:R.value.form.sortOrder,"onUpdate:modelValue":l[4]||(l[4]=e=>R.value.form.sortOrder=e),min:0},null,8,["modelValue"])]),_:1}),y(P,{label:"状态"},{default:h(()=>[y(S,{modelValue:R.value.form.status,"onUpdate:modelValue":l[5]||(l[5]=e=>R.value.form.status=e)},{default:h(()=>[y(Q,{label:"active"},{default:h(()=>[...l[18]||(l[18]=[g("启用",-1)])]),_:1}),y(Q,{label:"inactive"},{default:h(()=>[...l[19]||(l[19]=[g("禁用",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-5f424ce7"]]);export{j as default};
